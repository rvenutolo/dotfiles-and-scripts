#!/usr/bin/env bash

if [[ -z "${SDKMAN_DIR}" ]]; then
  echo 'SDKMAN_DIR is not set' >&2
  exit 2
fi

set -euo pipefail

sdkman_init="${SDKMAN_DIR}/bin/sdkman-init.sh"
if [[ -r "${sdkman_init}" ]] && [[ -f "${sdkman_init}" ]]; then
  set +ue
  source "${sdkman_init}"
  set -ue
else
  echo 'SDKMAN init script does not exist' >&2
  exit 2
fi

readonly sdkman_mvn="${SDKMAN_DIR}/candidates/maven/current/bin/mvn"
readonly sdkman_mvnd="${SDKMAN_DIR}/candidates/mvnd/current/bin/mvnd"

dir="$PWD"
project_root="$PWD"
while [[ "$dir" != / ]]; do
  if [[ -f "$dir/pom.xml" || -f "$dir/mvnw" ]]; then
    project_root="$dir"
    break
  fi
  dir="$(dirname "${dir}")"
done

if [[ -x "$project_root/mvnw" ]]; then
  echo "Executing mvnw instead of mvn" >&2
  "${project_root}/mvnw" "$@"
elif [[ -x "${sdkman_mvnd}" ]]; then
  echo "Executing mvnd instead of mvn" >&2
  "${sdkman_mvnd}" "$@"
elif [[ -x "${sdkman_mvn}" ]]; then
  "${sdkman_mvn}" "$@"
else
  echo 'No mvww, mvnd, or mvn avaialable' >&2
  exit 2
fi
